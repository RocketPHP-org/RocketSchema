{
  "@type": "Schema",
  "@context": "https://rocketschema.org/context",
  "name": "UserActivityLog",
  "description": "Comprehensive audit trail that records every significant action performed by users in the system. This entity serves as the forensic backbone for security monitoring, compliance reporting, and user behavior analysis. It captures not just what happened, but the full context - who did it, when, from where, what changed, and whether it succeeded or failed. Every login attempt, password change, profile update, permission modification, and data access is logged with enough detail to reconstruct events during security incidents. The log includes both successful and failed actions, which is crucial for detecting attack patterns like credential stuffing or privilege escalation attempts. Risk scoring helps identify suspicious activities automatically, while the preserved old and new values enable rollback capabilities. This audit trail is essential for compliance with regulations like GDPR, HIPAA, and SOX that require detailed activity logs. It's also valuable for user support, helping administrators understand what a user did before encountering an issue. The logs are typically retained for extended periods (years for compliance) and can be analyzed to detect insider threats, unusual access patterns, or systemic security issues.",
  "properties": [
    {
      "name": "user",
      "type": "User",
      "mode": "stored",
      "description": "User who performed the action",
      "required": true
    },
    {
      "name": "activityType",
      "type": "string",
      "mode": "enum",
      "description": "Category of activity performed",
      "enum": [
        "login",
        "logout",
        "password_change",
        "profile_update",
        "2fa_enable",
        "2fa_disable",
        "api_key_created",
        "api_key_revoked",
        "account_locked",
        "account_unlocked",
        "email_verified",
        "password_reset",
        "permission_changed",
        "data_export",
        "data_delete"
      ],
      "required": true
    },
    {
      "name": "timestamp",
      "type": "DateTime",
      "mode": "stored",
      "description": "Exact time when the activity occurred",
      "required": true
    },
    {
      "name": "ipAddress",
      "type": "string",
      "mode": "stored",
      "description": "IP address from which the action was performed",
      "nullable": true
    },
    {
      "name": "userAgent",
      "type": "string",
      "mode": "stored",
      "description": "Browser or application identifier",
      "nullable": true
    },
    {
      "name": "deviceId",
      "type": "uuid",
      "mode": "stored",
      "description": "Trusted device identifier if applicable",
      "nullable": true
    },
    {
      "name": "session",
      "type": "UserSession",
      "mode": "stored",
      "description": "Session during which this activity occurred",
      "nullable": true
    },
    {
      "name": "result",
      "type": "string",
      "mode": "enum",
      "description": "Outcome of the activity",
      "enum": [
        "success",
        "failure",
        "partial",
        "pending"
      ],
      "required": true
    },
    {
      "name": "errorCode",
      "type": "string",
      "mode": "stored",
      "description": "Specific error code if the action failed",
      "nullable": true
    },
    {
      "name": "errorMessage",
      "type": "string",
      "mode": "stored",
      "description": "Human-readable error description",
      "nullable": true
    },
    {
      "name": "changedFields",
      "type": "string",
      "mode": "stored",
      "description": "JSON array of fields that were modified",
      "nullable": true
    },
    {
      "name": "oldValues",
      "type": "string",
      "mode": "stored",
      "description": "Encrypted JSON of previous values for rollback",
      "nullable": true,
      "private": true
    },
    {
      "name": "newValues",
      "type": "string",
      "mode": "stored",
      "description": "Encrypted JSON of new values after change",
      "nullable": true,
      "private": true
    },
    {
      "name": "riskScore",
      "type": "integer",
      "mode": "stored",
      "description": "Calculated risk level of this activity (0-100)",
      "min": 0,
      "max": 100,
      "nullable": true
    },
    {
      "name": "riskFactors",
      "type": "string",
      "mode": "stored",
      "description": "JSON array of risk indicators detected",
      "nullable": true
    },
    {
      "name": "location",
      "type": "string",
      "mode": "stored",
      "description": "Geographic location based on IP",
      "nullable": true
    },
    {
      "name": "transactionId",
      "type": "uuid",
      "mode": "stored",
      "description": "Related transaction for grouped operations",
      "nullable": true
    },
    {
      "name": "metadata",
      "type": "string",
      "mode": "stored",
      "description": "Additional context in JSON format",
      "nullable": true
    }
  ],
  "examples": [
    {
      "@type": "UserActivityLog",
      "activityType": "password_change",
      "timestamp": "2024-03-15T14:30:00Z",
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/121.0",
      "result": "success",
      "changedFields": "[\"passwordHash\", \"passwordLastChangedAt\"]",
      "riskScore": 5,
      "riskFactors": "[\"known_device\", \"usual_location\"]",
      "location": "New York, NY, USA",
      "metadata": "{\"passwordStrength\": 85, \"method\": \"user_initiated\"}",
      "user": "user_550e8400",
      "session": "sess_xyz789"
    },
    {
      "@type": "UserActivityLog",
      "activityType": "login",
      "timestamp": "2024-03-15T09:00:00Z",
      "ipAddress": "203.0.113.45",
      "userAgent": "MyApp/2.1.0 (iPhone; iOS 17.0)",
      "deviceId": "dev_mobile_789",
      "result": "failure",
      "errorCode": "ACCOUNT_LOCKED",
      "errorMessage": "Account temporarily locked due to multiple failed login attempts",
      "riskScore": 75,
      "riskFactors": "[\"multiple_failures\", \"new_location\", \"vpn_detected\"]",
      "location": "Singapore",
      "metadata": "{\"attemptNumber\": 6, \"vpnProvider\": \"NordVPN\"}",
      "user": "user_6ba7b810"
    }
  ]
}