{
  "@type": "Schema",
  "@context": "https://rocketschema.org/context",
  "name": "TwoFactorAuth",
  "description": "Two-factor authentication configuration - NORMALIZED VERSION (3NF compliant)",
  "properties": [
    {
      "name": "twoFactorAuthId",
      "type": "uuid",
      "mode": "stored",
      "description": "Unique 2FA configuration identifier",
      "required": true,
      "unique": true
    },
    {
      "name": "userId",
      "type": "uuid",
      "mode": "stored",
      "description": "User this 2FA configuration belongs to",
      "required": true
    },
    {
      "name": "method",
      "type": "string",
      "mode": "enum",
      "description": "2FA method",
      "enum": ["totp", "sms", "email", "authenticator", "hardware_key", "biometric", "backup_codes"],
      "required": true,
      "example": "totp"
    },
    {
      "name": "isEnabled",
      "type": "boolean",
      "mode": "stored",
      "description": "Whether 2FA is enabled",
      "default": false
    },
    {
      "name": "isPrimary",
      "type": "boolean",
      "mode": "stored",
      "description": "Whether this is the primary 2FA method",
      "default": false
    },
    {
      "name": "secretHash",
      "type": "string",
      "mode": "stored",
      "description": "Encrypted secret for TOTP",
      "nullable": true,
      "private": true
    },
    {
      "name": "phoneNumber",
      "type": "string",
      "mode": "stored",
      "description": "Phone number for SMS-based 2FA",
      "nullable": true,
      "format": "phone"
    },
    {
      "name": "email",
      "type": "string",
      "mode": "stored",
      "description": "Email for email-based 2FA",
      "nullable": true,
      "format": "email"
    },
    {
      "name": "deviceName",
      "type": "string",
      "mode": "stored",
      "description": "Hardware key or authenticator device name",
      "nullable": true
    },
    {
      "name": "deviceSerial",
      "type": "string",
      "mode": "stored",
      "description": "Hardware device serial number",
      "nullable": true
    },
    {
      "name": "algorithm",
      "type": "string",
      "mode": "enum",
      "description": "Algorithm used for TOTP",
      "enum": ["SHA1", "SHA256", "SHA512"],
      "default": "SHA256"
    },
    {
      "name": "digits",
      "type": "integer",
      "mode": "stored",
      "description": "Number of digits for TOTP",
      "default": 6,
      "min": 6,
      "max": 8
    },
    {
      "name": "period",
      "type": "integer",
      "mode": "stored",
      "description": "Period in seconds for TOTP",
      "default": 30
    },
    {
      "name": "verifiedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "When the 2FA method was verified",
      "nullable": true
    },
    {
      "name": "lastUsedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last time this 2FA method was used",
      "nullable": true
    },
    {
      "name": "failedAttempts",
      "type": "integer",
      "mode": "stored",
      "description": "Number of consecutive failed 2FA attempts",
      "default": 0
    },
    {
      "name": "lockedUntil",
      "type": "DateTime",
      "mode": "stored",
      "description": "2FA locked until this timestamp",
      "nullable": true
    },
    {
      "name": "backupCodesGenerated",
      "type": "integer",
      "mode": "stored",
      "description": "Number of backup codes generated",
      "default": 0
    },
    {
      "name": "backupCodesRemaining",
      "type": "integer",
      "mode": "stored",
      "description": "Number of unused backup codes",
      "default": 0
    },
    {
      "name": "createdAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Creation timestamp",
      "required": true
    },
    {
      "name": "updatedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last update timestamp"
    },
    {
      "name": "version",
      "type": "integer",
      "mode": "stored",
      "description": "Version for optimistic locking",
      "default": 1
    }
  ],
  "relationships": {
    "backupCodes": {
      "type": "one-to-many",
      "entity": "TwoFactorBackupCode",
      "foreign_key": "twoFactorAuthId"
    },
    "trustedDevices": {
      "type": "one-to-many",
      "entity": "TrustedDevice",
      "foreign_key": "userId"
    }
  },
  "indexes": [
    {
      "fields": ["twoFactorAuthId"],
      "unique": true
    },
    {
      "fields": ["userId", "method"],
      "unique": true
    },
    {
      "fields": ["userId", "isPrimary"],
      "name": "idx_user_primary",
      "where": "isPrimary = true"
    },
    {
      "fields": ["userId", "isEnabled"],
      "name": "idx_user_enabled"
    }
  ]
}
