{
  "@type": "Schema",
  "@context": "https://rocketschema.org/context",
  "name": "RateLimitState",
  "description": "Tracks the real-time state of rate limits for active API consumers, maintaining counters and timestamps for enforcement decisions. While RateLimitConfig defines the rules, this entity stores the actual runtime data - how many requests have been made, when the current window started, and when it will reset. This separation allows for efficient, high-performance rate limiting even at massive scale. The entity implements various algorithms like token bucket (where tokens regenerate over time) or sliding window (tracking exact request times). For the token bucket algorithm, it tracks available tokens and when they were last refilled. The system updates this state on every API request, using optimistic locking to handle concurrent requests safely. When limits are exceeded, the isThrottled flag is set, and the system can return appropriate HTTP 429 (Too Many Requests) responses with headers indicating when the client can retry. This real-time tracking is typically implemented in fast storage like Redis for production systems, but this entity provides the persistent record for debugging, analytics, and system recovery after restarts.",
  "properties": [
    {
      "name": "entityType",
      "type": "string",
      "mode": "enum",
      "description": "Type of entity being rate limited",
      "enum": ["user", "api_key", "ip_address", "organization"],
      "required": true
    },
    {
      "name": "entityId",
      "type": "string",
      "mode": "stored",
      "description": "Identifier of the entity being tracked",
      "required": true
    },
    {
      "name": "bucket",
      "type": "string",
      "mode": "stored",
      "description": "Rate limit bucket identifier (combines entity and scope)",
      "required": true,
      "example": "api_key:550e8400:global"
    },
    {
      "name": "requestCount",
      "type": "integer",
      "mode": "stored",
      "description": "Number of requests in current window",
      "default": 0
    },
    {
      "name": "windowStart",
      "type": "DateTime",
      "mode": "stored",
      "description": "Start of the current rate limit window",
      "required": true
    },
    {
      "name": "windowEnd",
      "type": "DateTime",
      "mode": "stored",
      "description": "End of the current rate limit window",
      "required": true
    },
    {
      "name": "tokensAvailable",
      "type": "integer",
      "mode": "stored",
      "description": "Remaining tokens in token bucket algorithm",
      "nullable": true
    },
    {
      "name": "tokenCapacity",
      "type": "integer",
      "mode": "stored",
      "description": "Maximum tokens in the bucket",
      "nullable": true
    },
    {
      "name": "refillRate",
      "type": "number",
      "mode": "stored",
      "description": "Tokens added per second",
      "nullable": true
    },
    {
      "name": "lastRefillAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last time tokens were added to bucket",
      "nullable": true
    },
    {
      "name": "resetAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "When this rate limit window resets",
      "required": true
    },
    {
      "name": "isThrottled",
      "type": "boolean",
      "mode": "stored",
      "description": "Whether entity is currently being throttled",
      "default": false
    },
    {
      "name": "throttledAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "When throttling started",
      "nullable": true
    },
    {
      "name": "throttleCount",
      "type": "integer",
      "mode": "stored",
      "description": "Number of rejected requests while throttled",
      "default": 0
    },
    {
      "name": "lastRequestAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Timestamp of the most recent request",
      "nullable": true
    },
    {
      "name": "peakRequestRate",
      "type": "number",
      "mode": "stored",
      "description": "Highest requests/second observed in this window",
      "nullable": true
    },
    {
      "name": "version",
      "type": "integer",
      "mode": "stored",
      "description": "Version for optimistic locking during updates",
      "default": 1
    },
    {
      "name": "updatedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last time this state was modified",
      "required": true
    }
  ],
  "examples": [
    {
      "@type": "RateLimitState",
      "entityType": "api_key",
      "entityId": "key_550e8400",
      "bucket": "api_key:550e8400:global",
      "requestCount": 847,
      "windowStart": "2024-03-15T14:00:00Z",
      "windowEnd": "2024-03-15T15:00:00Z",
      "tokensAvailable": 153,
      "tokenCapacity": 1000,
      "refillRate": 0.28,
      "lastRefillAt": "2024-03-15T14:30:00Z",
      "resetAt": "2024-03-15T15:00:00Z",
      "isThrottled": false,
      "lastRequestAt": "2024-03-15T14:30:45Z",
      "peakRequestRate": 12.5,
      "version": 847,
      "updatedAt": "2024-03-15T14:30:45Z"
    },
    {
      "@type": "RateLimitState",
      "entityType": "ip_address",
      "entityId": "203.0.113.45",
      "bucket": "ip:203.0.113.45:auth",
      "requestCount": 10,
      "windowStart": "2024-03-15T14:29:00Z",
      "windowEnd": "2024-03-15T14:30:00Z",
      "resetAt": "2024-03-15T14:30:00Z",
      "isThrottled": true,
      "throttledAt": "2024-03-15T14:29:30Z",
      "throttleCount": 25,
      "lastRequestAt": "2024-03-15T14:29:55Z",
      "peakRequestRate": 5.0,
      "version": 35,
      "updatedAt": "2024-03-15T14:29:55Z"
    }
  ]
}
