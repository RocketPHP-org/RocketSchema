{
  "@type": "Schema",
  "@context": "https://rocketschema.org/context",
  "name": "ApiKey",
  "description": "API key for machine-to-machine authentication - NORMALIZED VERSION (3NF compliant)",
  "properties": [
    {
      "name": "apiKeyId",
      "type": "uuid",
      "mode": "stored",
      "description": "Unique API key identifier",
      "required": true,
      "unique": true
    },
    {
      "name": "keyHash",
      "type": "string",
      "mode": "stored",
      "description": "The API key hash",
      "required": true,
      "unique": true,
      "private": true
    },
    {
      "name": "keyPrefix",
      "type": "string",
      "mode": "stored",
      "description": "Visible prefix of the key for identification",
      "required": true,
      "example": "sk_live_abc"
    },
    {
      "name": "name",
      "type": "string",
      "mode": "stored",
      "description": "Friendly name for the API key",
      "required": true,
      "example": "Production API Key"
    },
    {
      "name": "description",
      "type": "string",
      "mode": "stored",
      "description": "Description of the key's purpose",
      "nullable": true
    },
    {
      "name": "type",
      "type": "string",
      "mode": "enum",
      "description": "Type of API key",
      "enum": ["public", "secret", "restricted", "test"],
      "default": "secret",
      "example": "secret"
    },
    {
      "name": "userId",
      "type": "uuid",
      "mode": "stored",
      "description": "User who owns this API key",
      "nullable": true
    },
    {
      "name": "organizationId",
      "type": "uuid",
      "mode": "stored",
      "description": "Organization that owns this API key",
      "nullable": true
    },
    {
      "name": "validFrom",
      "type": "DateTime",
      "mode": "stored",
      "description": "Start of validity period",
      "required": true
    },
    {
      "name": "validUntil",
      "type": "DateTime",
      "mode": "stored",
      "description": "End of validity period",
      "nullable": true
    },
    {
      "name": "lastUsedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last time this key was used",
      "nullable": true
    },
    {
      "name": "lastUsedIp",
      "type": "string",
      "mode": "stored",
      "description": "IP address of last use",
      "nullable": true
    },
    {
      "name": "usageCount",
      "type": "bigint",
      "mode": "stored",
      "description": "Total number of times used",
      "default": 0,
      "min": 0
    },
    {
      "name": "isActive",
      "type": "boolean",
      "mode": "stored",
      "description": "Whether the key is active",
      "default": true
    },
    {
      "name": "revokedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "When the key was revoked",
      "nullable": true
    },
    {
      "name": "revokedBy",
      "type": "uuid",
      "mode": "stored",
      "description": "User who revoked the key",
      "nullable": true
    },
    {
      "name": "revokedReason",
      "type": "string",
      "mode": "stored",
      "description": "Reason for revocation",
      "nullable": true
    },
    {
      "name": "createdAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Creation timestamp",
      "required": true
    },
    {
      "name": "createdBy",
      "type": "uuid",
      "mode": "stored",
      "description": "User who created the key",
      "nullable": true
    },
    {
      "name": "updatedAt",
      "type": "DateTime",
      "mode": "stored",
      "description": "Last update timestamp"
    },
    {
      "name": "version",
      "type": "integer",
      "mode": "stored",
      "description": "Version for optimistic locking",
      "default": 1
    }
  ],
  "relationships": {
    "scopes": {
      "type": "one-to-many",
      "entity": "ApiKeyScope",
      "foreign_key": "apiKeyId"
    },
    "permissions": {
      "type": "many-to-many",
      "entity": "Permission",
      "junction": "ApiKeyPermission"
    },
    "ipRestrictions": {
      "type": "one-to-many",
      "entity": "ApiKeyIpRestriction",
      "foreign_key": "apiKeyId"
    },
    "allowedOrigins": {
      "type": "one-to-many",
      "entity": "ApiKeyAllowedOrigin",
      "foreign_key": "apiKeyId"
    },
    "rateLimit": {
      "type": "one-to-many",
      "entity": "RateLimitConfig",
      "foreign_key": "entityId",
      "condition": "entityType = 'api_key'"
    }
  },
  "indexes": [
    {
      "fields": ["apiKeyId"],
      "unique": true
    },
    {
      "fields": ["keyHash"],
      "unique": true
    },
    {
      "fields": ["keyPrefix"],
      "name": "idx_prefix"
    },
    {
      "fields": ["userId"],
      "name": "idx_user"
    },
    {
      "fields": ["organizationId"],
      "name": "idx_organization"
    },
    {
      "fields": ["isActive", "validUntil"],
      "name": "idx_active_valid"
    }
  ]
}
